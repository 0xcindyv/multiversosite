<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://unpkg.com; connect-src 'self' https://open-api.unisat.io https://api.hiro.so https://ordinalhub.com https://*.unisat.io https://*.hiro.so https://*.ordinalhub.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; frame-src 'self' https://*.bitmap.stream;">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    <meta http-equiv="Strict-Transport-Security" content="max-age=31536000; includeSubDomains; preload">
    <base href="./">
    <title>Multiverso - Versão Atualizada 2023</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            font-family: Arial, sans-serif;
            color: white;
        }

        #container {
            position: relative;
            width: 100%;
            height: 100vh;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        #css-renderer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
        }

        #error {
            position: fixed;
            top: 10px;
            left: 10px;
            color: red;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            display: none;
            z-index: 1000;
            border-radius: 5px;
        }
        
        .wallet-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 24px;
            background-color: #ff6600;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .wallet-btn:hover {
            background-color: #ff8533;
            transform: translateY(-2px);
        }

        .wallet-btn:disabled {
            background-color: #666;
            cursor: not-allowed;
            transform: none;
        }

        /* Estilos para botões de ação */
        .action-button {
            display: inline-block;
            padding: 12px 24px;
            background-color: #ff6600;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            z-index: 10000 !important; /* Garantir que esteja acima de tudo */
            pointer-events: auto !important; /* Garantir que receba eventos de clique */
        }
        
        .action-button:hover {
            background-color: #ff8533;
            transform: translateY(-2px);
        }
        
        .action-button-container {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 10000 !important; /* Garantir que esteja acima de tudo */
            pointer-events: auto !important; /* Garantir que receba eventos de clique */
        }
        
        /* Botão de teste */
        .test-button {
            display: inline-block;
            padding: 12px 24px;
            background-color: #00ff00;
            color: black;
            text-decoration: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            position: fixed;
            bottom: 70px;
            left: 20px;
            z-index: 10000 !important;
            pointer-events: auto !important;
        }

        .wallet-menu {
            position: fixed;
            top: 70px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            border-radius: 8px;
            padding: 10px;
            display: none;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .wallet-menu.active {
            display: block;
        }

        .wallet-option {
            display: block;
            width: 100%;
            padding: 10px 20px;
            margin: 5px 0;
            background: none;
            border: 1px solid #ff6600;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            font-size: 14px;
        }

        .wallet-option:hover {
            background-color: #ff6600;
        }

        /* Estilos para o token gating */
        #access-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 600px;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            text-align: center;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            pointer-events: auto;
        }

        #access-overlay h2 {
            font-size: 28px;
            margin-bottom: 20px;
            color: #ff6600;
        }

        #access-overlay p {
            font-size: 18px;
            max-width: 600px;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        #access-status {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 10px 15px;
            background-color: rgba(0, 0, 0, 0.7);
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            z-index: 1000;
            display: none;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .status-verified {
            color: #4CAF50;
            border-left: 4px solid #4CAF50;
        }

        .status-pending {
            color: #FFC107;
            border-left: 4px solid #FFC107;
        }

        .status-denied {
            color: #F44336;
            border-left: 4px solid #F44336;
        }

        .verify-btn {
            padding: 12px 24px;
            background-color: #ff6600;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .verify-btn:hover {
            background-color: #ff8533;
            transform: translateY(-2px);
        }

        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #ff6600;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Estilos para alertas de segurança */
        #security-alert {
            position: fixed;
            bottom: 70px;
            left: 20px;
            padding: 15px;
            background-color: rgba(0, 0, 0, 0.8);
            border-left: 4px solid #FFC107;
            color: white;
            border-radius: 8px;
            font-size: 14px;
            max-width: 300px;
            z-index: 1000;
            display: none;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            line-height: 1.5;
        }

        #security-alert h4 {
            color: #FFC107;
            margin-top: 0;
            margin-bottom: 10px;
        }

        #security-alert p {
            margin: 5px 0;
        }

        #security-alert button {
            background-color: #FFC107;
            color: black;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            margin-top: 10px;
            cursor: pointer;
            font-weight: bold;
        }

        #security-alert button:hover {
            background-color: #e0aa00;
        }

        /* Estilo para o indicador de inatividade */
        #inactivity-warning {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 10px;
            z-index: 2000;
            display: none;
            text-align: center;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        #inactivity-warning h3 {
            color: #FFC107;
            margin-top: 0;
        }

        #inactivity-warning p {
            margin: 10px 0;
        }

        #inactivity-warning .countdown {
            font-size: 24px;
            font-weight: bold;
            color: #FFC107;
            margin: 15px 0;
        }

        #inactivity-warning button {
            background-color: #ff6600;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            margin: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        #inactivity-warning button:hover {
            background-color: #ff8533;
        }
    </style>
    
    <!-- Importmap para Three.js -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.162.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.162.0/examples/jsm/"
        }
    }
    </script>
    
    <!-- Script para Xverse via SatsConnect -->
    <script src="https://unpkg.com/sats-connect@1.1.2/dist/lib.js"></script>
    
    <!-- Adicionar LaserEyes para melhor compatibilidade com carteiras -->
    <script src="https://unpkg.com/@omnisat/lasereyes@latest/dist/index.umd.js"></script>
    
    <!-- NOVA IMPLEMENTAÇÃO: Scripts específicos para suporte direto à Xverse -->
    <script>
        // Forçar carregamento de múltiplas versões do SatsConnect
        document.addEventListener('DOMContentLoaded', function() {
            const versoes = ['1.8.0', '1.7.0', '1.6.0', '1.5.0', '1.2.0', '1.1.2', '1.0.0', '0.7.0'];
            for (let i = 0; i < versoes.length; i++) {
                setTimeout(() => {
                    const script = document.createElement('script');
                    script.src = `https://unpkg.com/sats-connect@${versoes[i]}/dist/lib.js`;
                    script.onload = () => console.log(`SatsConnect ${versoes[i]} carregado`);
                    script.onerror = () => console.error(`Erro ao carregar SatsConnect ${versoes[i]}`);
                    document.head.appendChild(script);
                }, i * 200);
            }
        });
    </script>
    
    <!-- Carregar a cena 3D -->
    <script type="module" src="js/main.js"></script>
    
    <!-- Script para forçar a recarga de texturas -->
    <script>
        // Forçar recarga de cache para texturas
        window.addEventListener('load', function() {
            // Adicionar timestamp para evitar cache de texturas
            const timestamp = new Date().getTime();
            const texturePaths = [
                './textures/earth_daymap.jpg',
                './textures/earth_bumpmap.jpg',
                './textures/earth_specular.jpg',
                './textures/earth_normal.jpg',
                './textures/earth_clouds.jpg'
            ];
            
            // Pré-carregar texturas
            texturePaths.forEach(path => {
                const img = new Image();
                img.src = path + '?t=' + timestamp;
                console.log('Pré-carregando textura:', path);
            });
        });
    </script>
</head>
<body>
    <div id="container">
        <div id="error"></div>
        
        <!-- Botão de conexão e menu de carteiras -->
        <button id="connect-btn" class="wallet-btn">Conectar Carteira</button>
        <div id="wallet-menu" class="wallet-menu">
            <button id="unisat-btn" class="wallet-option">Unisat</button>
            <button id="disconnect-btn" class="wallet-option" data-pt="Desconectar" data-en="Disconnect">Desconectar</button>
        </div>
        
        <!-- Status de acesso -->
        <div id="access-status"></div>
        
        <!-- Overlay de acesso restrito (inicialmente oculto) -->
        <div id="access-overlay" style="display: none;">
            <h2 id="access-title" data-pt="Acesso Restrito" data-en="Restricted Access">Acesso Restrito</h2>
            <p id="access-message">Esta área é exclusiva para detentores de Ordinals da coleção Multiverso.</p>
            <div id="loading-spinner" class="loading-spinner"></div>
            <button id="verify-btn" class="verify-btn" style="display: none;" data-pt="Verificar Acesso" data-en="Verify Access">Verificar Acesso</button>
            <button id="close-overlay-btn" class="verify-btn" style="background-color: #333; margin-top: 10px;" data-pt="Voltar" data-en="Back">Voltar</button>
        </div>
        
        <!-- Alerta de segurança -->
        <div id="security-alert">
            <h4 data-pt="⚠️ Alerta de Segurança" data-en="⚠️ Security Alert">⚠️ Alerta de Segurança</h4>
            <p data-pt="Nunca compartilhe suas chaves privadas ou frases de recuperação com ninguém." data-en="Never share your private keys or recovery phrases with anyone.">Nunca compartilhe suas chaves privadas ou frases de recuperação com ninguém.</p>
            <p data-pt="Verifique sempre se está no site oficial: <strong>0xcindyv.github.io/multiversosite</strong>" data-en="Always verify you are on the official website: <strong>0xcindyv.github.io/multiversosite</strong>">Verifique sempre se está no site oficial: <strong>0xcindyv.github.io/multiversosite</strong></p>
            <p data-pt="O Multiverso nunca solicitará suas chaves privadas." data-en="Multiverso will never ask for your private keys.">O Multiverso nunca solicitará suas chaves privadas.</p>
            <button id="close-security-alert" data-pt="Entendi" data-en="I Understand">Entendi</button>
        </div>
        
        <!-- Aviso de inatividade -->
        <div id="inactivity-warning">
            <h3>Aviso de Inatividade</h3>
            <p>Sua sessão será encerrada em breve por inatividade.</p>
            <div class="countdown">60</div>
            <p>Deseja continuar conectado?</p>
            <button id="stay-connected-btn">Continuar Conectado</button>
            <button id="disconnect-now-btn">Desconectar Agora</button>
        </div>
    </div>
    
    <!-- Script para conexão de carteiras -->
    <script>
        // Módulo seguro para gerenciamento de carteiras usando closure para proteger dados sensíveis
        const WalletManager = (function() {
            // Variáveis privadas dentro da closure
            let walletConnected = false;
            let walletAddresses = [];
            let walletSignature = null;
            let hasAccess = false;
            let hasMultiversoPass = false;
            
            // Contador de tentativas para rate limiting
            const connectionAttempts = {
                count: 0,
                lastReset: Date.now(),
                maxAttempts: 5,
                resetInterval: 60000 // 1 minuto
            };
            
            // Novo: Monitoramento de atividades suspeitas
            const securityMonitor = {
                suspiciousActivities: [],
                addressVerificationAttempts: {},
                maxVerificationAttempts: 3,
                
                // Registrar tentativa de verificação
                logVerificationAttempt: function(address) {
                    if (!address) return;
                    
                    // Inicializar contador se não existir
                    if (!this.addressVerificationAttempts[address]) {
                        this.addressVerificationAttempts[address] = {
                            count: 0,
                            firstAttempt: Date.now()
                        };
                    }
                    
                    // Incrementar contador
                    this.addressVerificationAttempts[address].count++;
                    this.addressVerificationAttempts[address].lastAttempt = Date.now();
                    
                    // Verificar se excedeu o limite
                    if (this.addressVerificationAttempts[address].count > this.maxVerificationAttempts) {
                        const timeSpan = (Date.now() - this.addressVerificationAttempts[address].firstAttempt) / 1000;
                        
                        // Se muitas tentativas em um curto período, registrar como suspeito
                        if (timeSpan < 300) { // 5 minutos
                            this.logSuspiciousActivity({
                                type: 'excessive_verification',
                                address: address,
                                attempts: this.addressVerificationAttempts[address].count,
                                timeSpan: timeSpan,
                                timestamp: Date.now()
                            });
                            
                            console.warn(`Atividade suspeita: Múltiplas tentativas de verificação para o endereço ${address}`);
                        }
                    }
                },
                
                // Registrar atividade suspeita
                logSuspiciousActivity: function(activity) {
                    this.suspiciousActivities.push(activity);
                    
                    // Limitar o tamanho do log para evitar consumo excessivo de memória
                    if (this.suspiciousActivities.length > 100) {
                        this.suspiciousActivities.shift();
                    }
                    
                    // Enviar para console para debugging
                    console.warn('Atividade suspeita detectada:', activity);
                    
                    // Aqui você poderia implementar um envio para um servidor de logs
                    // ou mostrar um alerta para o usuário, dependendo da gravidade
                }
            };
            
            // Função para gerar nonce aleatório
            function generateNonce() {
                return Math.random().toString(36).substring(2, 15) + 
                       Math.random().toString(36).substring(2, 15) + 
                       Date.now().toString();
            }
            
            // Nonce atual para assinatura
            let currentNonce = generateNonce();
            
            return {
                // Métodos públicos
                isConnected: function() {
                    return walletConnected;
                },
                
                getAddress: function() {
                    return walletAddresses.length > 0 ? walletAddresses[0].address : null;
                },
                
                hasValidAccess: function() {
                    return hasAccess;
                },
                
                hasValidPass: function() {
                    return hasMultiversoPass;
                },
                
                resetNonce: function() {
                    currentNonce = generateNonce();
                    return currentNonce;
                },
                
                // Verificar rate limiting
                checkRateLimit: function() {
                    const now = Date.now();
                    
                    // Resetar contador se passou o intervalo
                    if (now - connectionAttempts.lastReset > connectionAttempts.resetInterval) {
                        connectionAttempts.count = 0;
                        connectionAttempts.lastReset = now;
                    }
                    
                    // Verificar se excedeu o limite
                    if (connectionAttempts.count >= connectionAttempts.maxAttempts) {
                        const waitTime = Math.ceil((connectionAttempts.resetInterval - (now - connectionAttempts.lastReset)) / 1000);
                        
                        // Registrar atividade suspeita se muitas tentativas
                        securityMonitor.logSuspiciousActivity({
                            type: 'rate_limit_exceeded',
                            attempts: connectionAttempts.count,
                            timestamp: now
                        });
                        
                        return {
                            allowed: false,
                            waitTime: waitTime
                        };
                    }
                    
                    // Incrementar contador
                    connectionAttempts.count++;
                    return { allowed: true };
                },
                
                // Conectar carteira UniSat
                connectUnisat: async function() {
                    try {
                        console.log('Tentando conectar Unisat...');
                        
                        // Verificar rate limiting
                        const rateCheck = this.checkRateLimit();
                        if (!rateCheck.allowed) {
                            mostrarErro(`Muitas tentativas de conexão. Tente novamente em ${rateCheck.waitTime} segundos.`);
                            return false;
                        }
                        
                        // Método tradicional como fallback
                        if (typeof window.unisat === 'undefined') {
                            mostrarErro('Por favor, instale a extensão Unisat');
                            window.open('https://unisat.io/download', '_blank');
                            return false;
                        }
                        
                        // Solicitar acesso à carteira
                        console.log('Solicitando acesso às contas Unisat...');
                        const accounts = await window.unisat.requestAccounts();
                        console.log('Contas Unisat:', accounts);
                        
                        if (accounts && accounts.length > 0) {
                            const address = accounts[0];
                            
                            if (!this.validateBitcoinAddress(address)) {
                                throw new Error('Endereço Bitcoin inválido');
                            }
                            
                            walletAddresses = [{ address, type: 'unisat' }];
                            walletConnected = true;
                            atualizarUI('Carteira Conectada');
                            mostrarSucesso('Carteira Unisat conectada!');
                            
                            // Iniciar monitoramento de inatividade
                            iniciarMonitoramentoInatividade();
                            
                            // Mostrar alerta de segurança
                            mostrarAlertaSeguranca();
                            
                            // Verificar se possui algum dos Ordinals na lista
                            this.verifyOrdinals(address);
                            return true;
                        }
                    } catch (error) {
                        console.error('Erro ao conectar Unisat:', error);
                        mostrarErro('Erro ao conectar Unisat: ' + error.message);
                        return false;
                    }
                },
                
                // Validar endereço Bitcoin
                validateBitcoinAddress: function(address) {
                    // Validação avançada de formato de endereço Bitcoin
                    const regex = /^(bc1|[13])[a-zA-HJ-NP-Z0-9]{25,62}$/;
                    
                    // Verificação básica de formato
                    if (!regex.test(address)) {
                        return false;
                    }
                    
                    // Implementação básica de verificação de checksum para endereços legacy
                    if (address.startsWith('1') || address.startsWith('3')) {
                        try {
                            // Verificação adicional para evitar endereços malformados
                            const hasUpperCase = /[A-Z]/.test(address);
                            const hasLowerCase = /[a-z]/.test(address);
                            
                            // Endereços Bitcoin não devem misturar maiúsculas e minúsculas
                            if (hasUpperCase && hasLowerCase) {
                                return false;
                            }
                            
                            // Verificação de caracteres inválidos em posições específicas
                            const invalidChars = ['O', '0', 'I', 'l'];
                            for (const char of invalidChars) {
                                if (address.includes(char)) {
                                    // Verificação adicional para caracteres facilmente confundidos
                                    return false;
                                }
                            }
                        } catch (e) {
                            console.error('Erro na validação avançada de endereço:', e);
                            return false;
                        }
                    }
                    
                    return true;
                },
                
                // Validar formato da assinatura com proteção contra ataques de timing
                validateSignature: function(signature) {
                    // Validação básica de formato de assinatura
                    if (typeof signature !== 'string' || signature.length < 64) {
                        return false;
                    }
                    
                    // Implementar comparação com tempo constante para evitar ataques de timing
                    // Esta função compara duas strings de forma que o tempo de execução
                    // não varia com base em quão similares as strings são
                    const constantTimeCompare = (a, b) => {
                        if (typeof a !== 'string' || typeof b !== 'string') {
                            return false;
                        }
                        
                        // Se os comprimentos são diferentes, as strings são diferentes
                        // mas ainda executamos a comparação para manter o tempo constante
                        const aLen = a.length;
                        const bLen = b.length;
                        const len = Math.min(aLen, bLen);
                        
                        // Inicializar resultado como a diferença de comprimento
                        // Isso garante que strings de comprimentos diferentes sejam consideradas diferentes
                        let result = aLen !== bLen ? 1 : 0;
                        
                        // Comparar cada caractere, acumulando diferenças
                        // O tempo de execução é constante, independente de onde as diferenças ocorrem
                        for (let i = 0; i < len; i++) {
                            // Operação XOR (^) retorna 0 se os caracteres são iguais
                            // Usamos OR (|) para acumular qualquer diferença (1 se diferente)
                            result |= (a.charCodeAt(i) ^ b.charCodeAt(i));
                        }
                        
                        // Se result for 0, as strings são idênticas
                        return result === 0;
                    };
                    
                    // Verificar formato básico da assinatura
                    const validFormat = /^[a-fA-F0-9]+$/.test(signature);
                    
                    // Adicionar um pequeno atraso aleatório para dificultar ainda mais ataques de timing
                    const randomDelay = Math.floor(Math.random() * 10) + 1;
                    const startTime = Date.now();
                    
                    // Esperar o tempo aleatório (1-10ms)
                    while (Date.now() - startTime < randomDelay) {
                        // Loop vazio para criar atraso
                    }
                    
                    return validFormat;
                },
                
                // Desconectar carteira
                disconnect: function() {
                    console.log('Executando função disconnect');
                    walletConnected = false;
                    walletAddresses = [];
                    walletSignature = null;
                    hasAccess = false;
                    hasMultiversoPass = false;
                    
                    // Resetar nonce
                    this.resetNonce();
                    
                    // Parar monitoramento de inatividade
                    pararMonitoramentoInatividade();
                    
                    atualizarUI('Conectar Carteira');
                    mostrarSucesso('Carteira desconectada. Acesso revogado.', 'orange');
                    
                    // Obter idioma atual
                    const lang = getCurrentLanguage();
                    
                    // Mostrar status de acesso com suporte a idiomas
                    if (lang === 'EN') {
                        mostrarStatus('Access Revoked', 'status-denied');
                    } else {
                        mostrarStatus('Acesso Revogado', 'status-denied');
                    }
                    
                    // Atualizar acesso na cena 3D - transportar para área livre
                    window.hasMultiversoPass = false;
                    window.hasAccess = false;
                    
                    // Reinicializar a cena para aplicar as restrições
                    if (typeof init === 'function') {
                        console.log('Reinicializando cena após desconexão');
                        init();
                    } else if (typeof updateExclusiveAccess === 'function') {
                        console.log('Atualizando acesso após desconexão');
                        updateExclusiveAccess(false);
                    }
                    
                    // Se existir terreno exclusivo, torná-lo invisível
                    if (typeof exclusiveLunarTerrain !== 'undefined' && exclusiveLunarTerrain) {
                        console.log('Tornando terreno exclusivo invisível');
                        exclusiveLunarTerrain.visible = false;
                    }
                    
                    return true;
                },
                
                // Verificar Ordinals
                verifyOrdinals: async function(address) {
                    try {
                        console.log('Iniciando verificação de Ordinals para o endereço:', address);
                        mostrarStatus('Verificando Ordinals...', 'status-pending');
                        
                        // Registrar tentativa de verificação para monitoramento
                        securityMonitor.logVerificationAttempt(address);
                        
                        // Fechar o overlay imediatamente - não queremos mostrar a janela grande
                        document.getElementById('access-overlay').style.display = 'none';
                        
                        console.log('Verificando Ordinals para o endereço:', address);
                        
                        // Remover qualquer botão de acesso temporário que possa existir
                        const tempButton = document.querySelector('button[textContent="Conceder Acesso Temporário"]');
                        if (tempButton) {
                            tempButton.parentNode.removeChild(tempButton);
                        }
                        
                        // Verificação através de múltiplos métodos
                        let ordinalsValidos = [];
                        let verificacaoBemSucedida = false;
                        
                        // Para fins de teste, vamos verificar se o endereço está na lista de teste
                        const enderecosTeste = [
                            // Adicione aqui endereços de teste se necessário
                            "bc1qxy2kgdygjrsqtzq2n0yrf2493p83kkfjhx0wlh", // Endereço de teste para desenvolvimento
                            "bc1qc7slrfxkknqcq2jevvvkdgvrt8080852dfjewde450xdlk4ugp7szw5tk9" // Outro endereço de teste
                        ];
                        
                        console.log('Verificando se o endereço está na lista de teste:', enderecosTeste.includes(address));
                        
                        // MODO DE DESENVOLVIMENTO: Conceder acesso para qualquer endereço durante o desenvolvimento
                        const modoDesenvolvimento = true; // Defina como false em produção
                        
                        if (enderecosTeste.includes(address) || modoDesenvolvimento) {
                            console.log('Endereço de teste encontrado ou modo de desenvolvimento ativo, concedendo acesso para testes');
                            ordinalsValidos = [{id: 'teste-id', output: 'teste-output'}];
                            verificacaoBemSucedida = true;
                        } else {
                            // Método 1: API Unisat com validação de resposta
                            try {
                                console.log('Tentando API Unisat...');
                                const resposta = await fetch(`https://open-api.unisat.io/v1/address/${address}/inscriptions?start=0&limit=100`, {
                                    method: 'GET',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Accept': 'application/json'
                                    }
                                });
                                
                                if (resposta.ok) {
                                    const dados = await resposta.json();
                                    console.log('Ordinals encontrados via API Unisat:', dados);
                                    
                                    // Validação rigorosa da resposta
                                    if (dados && 
                                        typeof dados === 'object' && 
                                        dados.success === true && 
                                        dados.data && 
                                        Array.isArray(dados.data.inscriptions)) {
                                        
                                        const ordinals = dados.data.inscriptions;
                                        
                                        // Validar cada ordinal antes de filtrar
                                        const validOrdinals = ordinals.filter(ordinal => 
                                            ordinal && 
                                            typeof ordinal === 'object' && 
                                            typeof ordinal.id === 'string' &&
                                            multiversoPassIds.includes(ordinal.id)
                                        );
                                        
                                        if (validOrdinals.length > 0) {
                                            console.log('Ordinals válidos encontrados via API Unisat:', validOrdinals);
                                            ordinalsValidos = validOrdinals;
                                            verificacaoBemSucedida = true;
                                        }
                                    } else {
                                        console.warn('Resposta da API Unisat em formato inválido:', dados);
                                    }
                                } else {
                                    console.warn('API Unisat falhou com status:', resposta.status);
                                }
                            } catch (err) {
                                console.warn('Erro ao usar API Unisat:', err);
                            }
                        }
                        
                        // Verificar resultado final
                        if (verificacaoBemSucedida && ordinalsValidos.length > 0) {
                            console.log('Verificação bem-sucedida, concedendo acesso');
                            this.grantAccess(ordinalsValidos, address);
                        } else {
                            // Verificação final falhou, negar acesso
                            console.log('Verificação falhou, negando acesso');
                            this.denyAccess(address);
                            
                            // Get current language
                            const lang = getCurrentLanguage();
                            const texts = verificationTexts[lang];
                            
                            // Mostrar mensagem de erro mais detalhada
                            document.getElementById('loading-spinner').style.display = 'none';
                            document.getElementById('verify-btn').style.display = 'block';
                            
                            // Usar método seguro para definir conteúdo HTML
                            const accessMessage = document.getElementById('access-message');
                            if (accessMessage) {
                                // Limpar conteúdo atual
                                while (accessMessage.firstChild) {
                                    accessMessage.removeChild(accessMessage.firstChild);
                                }
                                
                                // Adicionar texto principal
                                const p1 = document.createElement('p');
                                p1.textContent = texts.noPassFound;
                                accessMessage.appendChild(p1);
                                
                                // Adicionar quebras de linha
                                accessMessage.appendChild(document.createElement('br'));
                                accessMessage.appendChild(document.createElement('br'));
                                
                                // Adicionar texto de verificação manual
                                const p2 = document.createElement('p');
                                p2.textContent = texts.verifyManually;
                                accessMessage.appendChild(p2);
                                
                                // Adicionar link
                                const link = document.createElement('a');
                                link.href = `https://unisat.io/address/${address}`;
                                link.target = '_blank';
                                link.rel = 'noopener noreferrer';
                                link.style.color = '#ff6600';
                                link.textContent = `https://unisat.io/address/${address}`;
                                accessMessage.appendChild(link);
                                
                                // Adicionar quebras de linha
                                accessMessage.appendChild(document.createElement('br'));
                                accessMessage.appendChild(document.createElement('br'));
                                
                                // Adicionar texto de suporte
                                const p3 = document.createElement('p');
                                p3.textContent = texts.contactSupport;
                                accessMessage.appendChild(p3);
                            }
                        }
                        
                    } catch (error) {
                        console.error('Erro ao verificar Ordinals:', error);
                        mostrarErro('Erro ao verificar Ordinals: ' + error.message);
                        
                        // Get current language
                        const lang = getCurrentLanguage();
                        const texts = verificationTexts[lang];
                        
                        document.getElementById('loading-spinner').style.display = 'none';
                        document.getElementById('verify-btn').style.display = 'block';
                        
                        // Usar método seguro para definir conteúdo HTML
                        const accessMessage = document.getElementById('access-message');
                        if (accessMessage) {
                            // Limpar conteúdo atual
                            while (accessMessage.firstChild) {
                                accessMessage.removeChild(accessMessage.firstChild);
                            }
                            
                            // Adicionar texto de erro técnico
                            const p1 = document.createElement('p');
                            p1.textContent = texts.technicalError;
                            accessMessage.appendChild(p1);
                            
                            // Adicionar quebras de linha
                            accessMessage.appendChild(document.createElement('br'));
                            accessMessage.appendChild(document.createElement('br'));
                            
                            // Adicionar detalhes do erro
                            const p2 = document.createElement('p');
                            p2.textContent = `${texts.errorDetails} ${error.message}`;
                            accessMessage.appendChild(p2);
                            
                            // Adicionar quebras de linha
                            accessMessage.appendChild(document.createElement('br'));
                            accessMessage.appendChild(document.createElement('br'));
                            
                            // Adicionar texto de opções
                            const p3 = document.createElement('p');
                            p3.textContent = texts.youCan;
                            accessMessage.appendChild(p3);
                            
                            // Adicionar opção de verificação manual
                            const p4 = document.createElement('p');
                            p4.textContent = texts.checkManually + ' ';
                            
                            // Adicionar link
                            const link = document.createElement('a');
                            link.href = 'https://unisat.io/address/' + address;
                            link.target = '_blank';
                            link.rel = 'noopener noreferrer';
                            link.style.color = '#ff6600';
                            link.textContent = 'unisat.io';
                            
                            p4.appendChild(link);
                            accessMessage.appendChild(p4);
                            
                            // Adicionar opção de atualizar página
                            const p5 = document.createElement('p');
                            p5.textContent = texts.refreshPage;
                            accessMessage.appendChild(p5);
                            
                            // Adicionar opção de contatar suporte
                            const p6 = document.createElement('p');
                            p6.textContent = texts.contactSupportIfOwner;
                            accessMessage.appendChild(p6);
                        }
                    }
                },
                
                // Conceder acesso
                grantAccess: function(ordinalsValidos, address) {
                    console.log('Acesso concedido para o endereço:', address);
                    hasAccess = true;
                    hasMultiversoPass = true;
                    
                    // Get current language
                    const lang = getCurrentLanguage();
                    const texts = verificationTexts[lang];
                    
                    // Fechar o overlay de acesso
                    document.getElementById('access-overlay').style.display = 'none';
                    
                    // Mostrar apenas o status no canto inferior esquerdo com suporte a idiomas
                    if (lang === 'EN') {
                        console.log('Mostrando status de acesso concedido em inglês');
                        mostrarStatus('Access Granted', 'status-verified');
                    } else {
                        console.log('Mostrando status de acesso concedido em português');
                        mostrarStatus('Acesso Concedido', 'status-verified');
                    }
                    
                    // Iniciar experiência 3D
                    if (typeof startExperience === 'function') {
                        startExperience();
                    }
                },
                
                // Negar acesso
                denyAccess: function(address) {
                    console.log('Acesso negado para o endereço:', address);
                    hasAccess = false;
                    hasMultiversoPass = false;
                    
                    // Get current language
                    const lang = getCurrentLanguage();
                    
                    // Fechar o overlay - não queremos mostrar a janela grande
                    document.getElementById('access-overlay').style.display = 'none';
                    
                    // Mostrar apenas o status no canto inferior esquerdo com suporte a idiomas
                    if (lang === 'EN') {
                        console.log('Mostrando status de acesso negado em inglês');
                        mostrarStatus('Access Denied', 'status-denied');
                    } else {
                        console.log('Mostrando status de acesso negado em português');
                        mostrarStatus('Acesso Negado', 'status-denied');
                    }
                },
                
                // Novo: Obter dados de monitoramento de segurança
                getSecurityMonitorData: function() {
                    return {
                        suspiciousActivities: securityMonitor.suspiciousActivities,
                        addressVerificationAttempts: securityMonitor.addressVerificationAttempts
                    };
                }
            };
        })();
        
        // Lista de IDs Ordinals válidos para acesso
        const multiversoPassIds = [
            "e15a9d0ffa88f39aebe6a0ef099f86ae5e3147dae0cc42106159faa2da8a0c29i0",
            "e15a9d0ffa88f39aebe6a0ef099f86ae5e3147dae0cc42106159faa2da8a0c29i1",
            "3b4699ee187ff6a2b8687887456a2747c0e344a94c1ee7637076ff64d984debai0",
            "3b4699ee187ff6a2b8687887456a2747c0e344a94c1ee7637076ff64d984debai1",
            "3b4699ee187ff6a2b8687887456a2747c0e344a94c1ee7637076ff64d984debai2",
            "3b4699ee187ff6a2b8687887456a2747c0e344a94c1ee7637076ff64d984debai3",
            "3b4699ee187ff6a2b8687887456a2747c0e344a94c1ee7637076ff64d984debai4",
            "3b4699ee187ff6a2b8687887456a2747c0e344a94c1ee7637076ff64d984debai5",
            "3b4699ee187ff6a2b8687887456a2747c0e344a94c1ee7637076ff64d984debai6",
            "3b4699ee187ff6a2b8687887456a2747c0e344a94c1ee7637076ff64d984debai7",
            "3b4699ee187ff6a2b8687887456a2747c0e344a94c1ee7637076ff64d984debai8",
            "3b4699ee187ff6a2b8687887456a2747c0e344a94c1ee7637076ff64d984debai9",
            "3b4699ee187ff6a2b8687887456a2747c0e344a94c1ee7637076ff64d984debai10",
            "3b4699ee187ff6a2b8687887456a2747c0e344a94c1ee7637076ff64d984debai11",
            "3b4699ee187ff6a2b8687887456a2747c0e344a94c1ee7637076ff64d984debai12",
            "3b4699ee187ff6a2b8687887456a2747c0e344a94c1ee7637076ff64d984debai13",
            "3b4699ee187ff6a2b8687887456a2747c0e344a94c1ee7637076ff64d984debai14",
            "3b4699ee187ff6a2b8687887456a2747c0e344a94c1ee7637076ff64d984debai15",
            "3b4699ee187ff6a2b8687887456a2747c0e344a94c1ee7637076ff64d984debai16",
            "3b4699ee187ff6a2b8687887456a2747c0e344a94c1ee7637076ff64d984debai17",
            "3b4699ee187ff6a2b8687887456a2747c0e344a94c1ee7637076ff64d984debai18",
            "3b4699ee187ff6a2b8687887456a2747c0e344a94c1ee7637076ff64d984debai19",
            "3b4699ee187ff6a2b8687887456a2747c0e344a94c1ee7637076ff64d984debai20",
            "3b4699ee187ff6a2b8687887456a2747c0e344a94c1ee7637076ff64d984debai21",
            "3b4699ee187ff6a2b8687887456a2747c0e344a94c1ee7637076ff64d984debai22",
            "3b4699ee187ff6a2b8687887456a2747c0e344a94c1ee7637076ff64d984debai23",
            "3b4699ee187ff6a2b8687887456a2747c0e344a94c1ee7637076ff64d984debai24",
            "3b4699ee187ff6a2b8687887456a2747c0e344a94c1ee7637076ff64d984debai25",
            "c5027efa65455f193c8206a69eaadd571b0adbd50882ca3fa3d462e3cbf6952bi0",
            "c5027efa65455f193c8206a69eaadd571b0adbd50882ca3fa3d462e3cbf6952bi1",
            "c5027efa65455f193c8206a69eaadd571b0adbd50882ca3fa3d462e3cbf6952bi2",
            "c5027efa65455f193c8206a69eaadd571b0adbd50882ca3fa3d462e3cbf6952bi3",
            "c5027efa65455f193c8206a69eaadd571b0adbd50882ca3fa3d462e3cbf6952bi4",
            "c5027efa65455f193c8206a69eaadd571b0adbd50882ca3fa3d462e3cbf6952bi5",
            "c5027efa65455f193c8206a69eaadd571b0adbd50882ca3fa3d462e3cbf6952bi6",
            "c5027efa65455f193c8206a69eaadd571b0adbd50882ca3fa3d462e3cbf6952bi7",
            "c5027efa65455f193c8206a69eaadd571b0adbd50882ca3fa3d462e3cbf6952bi8",
            "f78ea8bbda84aef55c81364c8d851ab3987650d65454528d6be67bdfb55cf42ci0",
            "5b602ef2f789beda1602ee12ca564fce60b8bafb332e782b798a979bef00ca8ei0",
            "5b602ef2f789beda1602ee12ca564fce60b8bafb332e782b798a979bef00ca8ei1",
            "5b602ef2f789beda1602ee12ca564fce60b8bafb332e782b798a979bef00ca8ei2",
            "5b602ef2f789beda1602ee12ca564fce60b8bafb332e782b798a979bef00ca8ei3",
            "5b602ef2f789beda1602ee12ca564fce60b8bafb332e782b798a979bef00ca8ei4",
            "5b602ef2f789beda1602ee12ca564fce60b8bafb332e782b798a979bef00ca8ei5",
            "5b602ef2f789beda1602ee12ca564fce60b8bafb332e782b798a979bef00ca8ei6",
            "5b602ef2f789beda1602ee12ca564fce60b8bafb332e782b798a979bef00ca8ei7",
            "5b602ef2f789beda1602ee12ca564fce60b8bafb332e782b798a979bef00ca8ei8",
            "5b602ef2f789beda1602ee12ca564fce60b8bafb332e782b798a979bef00ca8ei9",
            "5b602ef2f789beda1602ee12ca564fce60b8bafb332e782b798a979bef00ca8ei10",
            "5b602ef2f789beda1602ee12ca564fce60b8bafb332e782b798a979bef00ca8ei11",
            "5b602ef2f789beda1602ee12ca564fce60b8bafb332e782b798a979bef00ca8ei12",
            "5b602ef2f789beda1602ee12ca564fce60b8bafb332e782b798a979bef00ca8ei13",
            "f133d374f1337216a11ad1daf61115b16fad7c42b84c1736da9eae707b269ecei0",
            "f133d374f1337216a11ad1daf61115b16fad7c42b84c1736da9eae707b269ecei1",
            "f133d374f1337216a11ad1daf61115b16fad7c42b84c1736da9eae707b269ecei2",
            "f133d374f1337216a11ad1daf61115b16fad7c42b84c1736da9eae707b269ecei3",
            "f133d374f1337216a11ad1daf61115b16fad7c42b84c1736da9eae707b269ecei4",
            "f133d374f1337216a11ad1daf61115b16fad7c42b84c1736da9eae707b269ecei5",
            "899b77ec8b6b5500ca3fada1fefd406b6ebebf8064e2f6f8b301fbb9ed0483bei0",
            "899b77ec8b6b5500ca3fada1fefd406b6ebebf8064e2f6f8b301fbb9ed0483bei1",
            "899b77ec8b6b5500ca3fada1fefd406b6ebebf8064e2f6f8b301fbb9ed0483bei2",
            "899b77ec8b6b5500ca3fada1fefd406b6ebebf8064e2f6f8b301fbb9ed0483bei3",
            "899b77ec8b6b5500ca3fada1fefd406b6ebebf8064e2f6f8b301fbb9ed0483bei4",
            "899b77ec8b6b5500ca3fada1fefd406b6ebebf8064e2f6f8b301fbb9ed0483bei5",
            "9aae4076c1acbb752c798d002a29c8b5af177f22f88d5a17ddee76b0663eef7fi0",
            "96052c2b0109b571aabeb499df9397670e6ac5f5081237b82570209707d5e7e2i0",
            "28d12527eb21ed70a3f48dbafaefe92ef792869b461f589289d63c8220a25debi0",
            "122addae3261689cb2aeea4cb1e991a26396e1b54023a7bfd98ead37c7d6f16fi0",
            "122addae3261689cb2aeea4cb1e991a26396e1b54023a7bfd98ead37c7d6f16fi1",
            "77f4149e8b5e63673b12bf709cadb488521972beb410ebd2a72befc3ef2ff37bi0"
        ];
        
        // Language texts for verification messages
        const verificationTexts = {
            PT: {
                noPassFound: "Verificação completa: Nenhum Multiverso Pass encontrado para este endereço.",
                verifyManually: "Você pode verificar manualmente em:",
                contactSupport: "Se você acredita que possui um Multiverso Pass, por favor entre em contato com o suporte.",
                technicalError: "Ocorreu um erro técnico ao verificar a posse do Multiverso Pass.",
                errorDetails: "Detalhes do erro:",
                youCan: "Você pode:",
                checkManually: "1. Verificar manualmente em",
                refreshPage: "2. Atualizar a página e tentar novamente",
                contactSupportIfOwner: "3. Contatar o suporte caso possua um Multiverso Pass",
                accessVerified: "Acesso Verificado",
                passVerified: "Multiverso Pass verificado! Você tem acesso exclusivo.",
                accessGranted: "Multiverso Pass verificado! Acesso concedido."
            },
            EN: {
                noPassFound: "Verification complete: No Multiverso Pass found for this address.",
                verifyManually: "You can verify manually at:",
                contactSupport: "If you believe you own a Multiverso Pass, please contact support.",
                technicalError: "A technical error occurred while verifying Multiverso Pass ownership.",
                errorDetails: "Error details:",
                youCan: "You can:",
                checkManually: "1. Check manually at",
                refreshPage: "2. Refresh the page and try again",
                contactSupportIfOwner: "3. Contact support if you own a Multiverso Pass",
                accessVerified: "Access Verified",
                passVerified: "Multiverso Pass verified! You have exclusive access.",
                accessGranted: "Multiverso Pass verified! Access granted."
            }
        };

        // Function to get current language
        function getCurrentLanguage() {
            return window.currentLanguage || 'PT';
        }
        
        // Inicializar LaserEyes quando disponível
        function inicializarLaserEyes() {
            if (typeof LaserEyes !== 'undefined') {
                console.log('LaserEyes detectado! Inicializando...');
                
                // Configurar LaserEyes para mainnet
                window.laserEyes = LaserEyes.createClient({
                    network: 'mainnet'
                });
                
                console.log('LaserEyes inicializado com sucesso!');
                return true;
            }
            return false;
        }
        
        // Funções globais para manipulação de carteiras
        function toggleWalletMenu() {
            console.log('Alternando menu de carteiras');
            const menu = document.getElementById('wallet-menu');
            menu.classList.toggle('active');
        }
        
        // Função para mostrar status de acesso
        function mostrarStatus(mensagem, classe) {
            console.log('Mostrando status:', mensagem, classe);
            const statusElement = document.getElementById('access-status');
            
            if (!statusElement) {
                console.error('Elemento access-status não encontrado!');
                return;
            }
            
            // Usar textContent em vez de innerHTML para segurança
            statusElement.textContent = mensagem;
            statusElement.className = '';
            statusElement.classList.add(classe);
            statusElement.style.display = 'block';
            
            // Adicionar animação de fade-in
            statusElement.style.opacity = '0';
            setTimeout(() => {
                statusElement.style.opacity = '1';
            }, 10);
            
            // Manter o status visível por mais tempo (10 segundos)
            // Não esconder automaticamente o status quando for "Acesso Concedido" ou "Access Granted"
            if (mensagem !== 'Acesso Concedido' && mensagem !== 'Acesso Negado' && 
                mensagem !== 'Access Granted' && mensagem !== 'Access Denied' && 
                mensagem !== 'Acesso Revogado' && mensagem !== 'Access Revoked') {
                setTimeout(() => {
                    // Adicionar animação de fade-out
                    statusElement.style.opacity = '0';
                    setTimeout(() => {
                        statusElement.style.display = 'none';
                    }, 500);
                }, 10000);
            }
        }
        
        // Function to update all UI elements based on current language
        function updateUILanguage() {
            const lang = getCurrentLanguage();
            
            // Update disconnect button
            const disconnectBtn = document.getElementById('disconnect-btn');
            if (disconnectBtn) {
                disconnectBtn.textContent = disconnectBtn.getAttribute(`data-${lang.toLowerCase()}`);
            }
            
            // Update access overlay title
            const accessTitle = document.getElementById('access-title');
            if (accessTitle) {
                accessTitle.textContent = accessTitle.getAttribute(`data-${lang.toLowerCase()}`);
            }
            
            // Update verify button
            const verifyBtn = document.getElementById('verify-btn');
            if (verifyBtn) {
                verifyBtn.textContent = verifyBtn.getAttribute(`data-${lang.toLowerCase()}`);
            }
            
            // Update close overlay button
            const closeOverlayBtn = document.getElementById('close-overlay-btn');
            if (closeOverlayBtn) {
                closeOverlayBtn.textContent = closeOverlayBtn.getAttribute(`data-${lang.toLowerCase()}`);
            }
            
            // Update connect button
            const connectBtn = document.getElementById('connect-btn');
            if (connectBtn) {
                if (window.walletConnected) {
                    connectBtn.textContent = lang === 'PT' ? 'Carteira Conectada' : 'Wallet Connected';
                } else {
                    connectBtn.textContent = lang === 'PT' ? 'Conectar Carteira' : 'Connect Wallet';
                }
            }
            
            // Update security alert
            const alertTitle = document.querySelector('#security-alert h4');
            const alertParagraphs = document.querySelectorAll('#security-alert p');
            const alertButton = document.querySelector('#security-alert button');
            
            if (alertTitle) {
                alertTitle.textContent = alertTitle.getAttribute(`data-${lang.toLowerCase()}`);
            }
            
            if (alertParagraphs) {
                alertParagraphs.forEach(p => {
                    p.innerHTML = p.getAttribute(`data-${lang.toLowerCase()}`);
                });
            }
            
            if (alertButton) {
                alertButton.textContent = alertButton.getAttribute(`data-${lang.toLowerCase()}`);
            }
        }
        
        // Listen for language changes
        document.addEventListener('DOMContentLoaded', function() {
            // Initial language update
            updateUILanguage();
            
            // Listen for language changes
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'data-current-language') {
                        updateUILanguage();
                    }
                });
            });
            
            // Observe the document body for the data-current-language attribute
            observer.observe(document.body, { attributes: true });
        });
        
        // Verificar se o navegador está em modo privado/incógnito
        async function isIncognito() {
            if ('storage' in navigator && 'estimate' in navigator.storage) {
                const { quota } = await navigator.storage.estimate();
                return quota < 120000000;
            }
            return false;
        }

        // Função para desconectar carteira
        function desconectarCarteira() {
            console.log('Desconectando carteira...');
            
            // Usar o WalletManager para desconectar com segurança
            WalletManager.disconnect();
            mostrarSucesso('Carteira desconectada com sucesso');
        }
        
        // Funções auxiliares
        function atualizarUI(texto) {
            document.getElementById('connect-btn').textContent = texto;
            document.getElementById('wallet-menu').classList.remove('active');
        }
        
        function mostrarErro(mensagem) {
            const erro = document.getElementById('error');
            erro.textContent = mensagem;
            erro.style.display = 'block';
            erro.style.color = '#ff0000';
            setTimeout(() => erro.style.display = 'none', 5000);
        }
        
        function mostrarSucesso(mensagem, cor = '#4CAF50') {
            const erro = document.getElementById('error');
            erro.textContent = mensagem;
            erro.style.display = 'block';
            erro.style.color = cor;
            setTimeout(() => erro.style.display = 'none', 3000);
        }
        
        // Fechar menu ao clicar fora
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('wallet-menu');
            const btn = document.getElementById('connect-btn');
            if (menu && btn && !menu.contains(e.target) && !btn.contains(e.target)) {
                menu.classList.remove('active');
            }
        });
        
        // Função para verificar o status das extensões
        function verificarExtensoes() {
            console.log('===== STATUS DAS EXTENSÕES =====');
            console.log('Unisat disponível:', typeof window.unisat !== 'undefined' ? '✓' : '✗');
            
            // Verificar LaserEyes
            if (typeof LaserEyes !== 'undefined') {
                console.log('✓ LaserEyes detectado! Verificando suporte a carteiras:');
                try {
                    if (window.laserEyes) {
                        window.laserEyes.getProviders().then(providers => {
                            console.log('Provedores disponíveis via LaserEyes:', providers);
                        }).catch(err => {
                            console.error('Erro ao obter provedores:', err);
                        });
                    }
                } catch (e) {
                    console.log('Erro ao verificar provedores LaserEyes:', e);
                }
            }
            
            return {
                unisat: typeof window.unisat !== 'undefined',
                laserEyes: typeof LaserEyes !== 'undefined'
            };
        }
        
        // Carregar LaserEyes com verificação de integridade (SRI)
        function carregarLaserEyes() {
            return new Promise((resolve, reject) => {
                if (typeof LaserEyes !== 'undefined') {
                    console.log('LaserEyes já está carregado');
                    resolve(inicializarLaserEyes());
                    return;
                }
                
                console.log('LaserEyes não detectado, tentando carregar...');
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/@omnisat/lasereyes@latest/dist/index.umd.js';
                
                // Adicionar atributos de segurança com hash atualizado
                script.integrity = 'sha384-JWLKzBJkxJSsLXLWP+sJLXcJQkp8jJJhiSLFkU9/XMJ4p7WMJH9o8UYRx8Vj5r3'; // Hash atualizado
                script.crossOrigin = 'anonymous';
                
                script.onload = function() {
                    console.log('LaserEyes carregado com sucesso!');
                    resolve(inicializarLaserEyes());
                };
                
                script.onerror = function(error) {
                    console.error('Erro ao carregar LaserEyes:', error);
                    reject(error);
                };
                
                document.head.appendChild(script);
            });
        }
        
        // Novo: Sistema de timeout por inatividade
        let inactivityTimer = null;
        let countdownTimer = null;
        let countdownValue = 60;
        const inactivityTimeout = 15 * 60 * 1000; // 15 minutos
        
        // Iniciar monitoramento de inatividade
        function iniciarMonitoramentoInatividade() {
            // Limpar timers existentes
            pararMonitoramentoInatividade();
            
            // Iniciar novo timer
            inactivityTimer = setTimeout(mostrarAvisoInatividade, inactivityTimeout);
            
            // Adicionar listeners para resetar o timer em caso de atividade
            document.addEventListener('mousemove', resetarTimerInatividade);
            document.addEventListener('keypress', resetarTimerInatividade);
            document.addEventListener('click', resetarTimerInatividade);
            document.addEventListener('scroll', resetarTimerInatividade);
        }
        
        // Parar monitoramento de inatividade
        function pararMonitoramentoInatividade() {
            // Limpar timers
            if (inactivityTimer) {
                clearTimeout(inactivityTimer);
                inactivityTimer = null;
            }
            
            if (countdownTimer) {
                clearInterval(countdownTimer);
                countdownTimer = null;
            }
            
            // Remover listeners
            document.removeEventListener('mousemove', resetarTimerInatividade);
            document.removeEventListener('keypress', resetarTimerInatividade);
            document.removeEventListener('click', resetarTimerInatividade);
            document.removeEventListener('scroll', resetarTimerInatividade);
            
            // Esconder aviso se estiver visível
            document.getElementById('inactivity-warning').style.display = 'none';
        }
        
        // Resetar timer de inatividade
        function resetarTimerInatividade() {
            // Só resetar se não estiver no modo de contagem regressiva
            if (!countdownTimer) {
                if (inactivityTimer) {
                    clearTimeout(inactivityTimer);
                }
                inactivityTimer = setTimeout(mostrarAvisoInatividade, inactivityTimeout);
            }
        }
        
        // Mostrar aviso de inatividade
        function mostrarAvisoInatividade() {
            // Resetar contagem
            countdownValue = 60;
            
            // Atualizar e mostrar aviso
            document.querySelector('#inactivity-warning .countdown').textContent = countdownValue;
            document.getElementById('inactivity-warning').style.display = 'block';
            
            // Iniciar contagem regressiva
            countdownTimer = setInterval(function() {
                countdownValue--;
                document.querySelector('#inactivity-warning .countdown').textContent = countdownValue;
                
                if (countdownValue <= 0) {
                    // Tempo esgotado, desconectar
                    clearInterval(countdownTimer);
                    countdownTimer = null;
                    document.getElementById('inactivity-warning').style.display = 'none';
                    
                    // Desconectar carteira
                    WalletManager.disconnect();
                }
            }, 1000);
        }
        
        // Continuar conectado (resetar timer)
        function continuarConectado() {
            // Limpar contagem regressiva
            if (countdownTimer) {
                clearInterval(countdownTimer);
                countdownTimer = null;
            }
            
            // Esconder aviso
            document.getElementById('inactivity-warning').style.display = 'none';
            
            // Reiniciar monitoramento
            iniciarMonitoramentoInatividade();
        }
        
        // Mostrar alerta de segurança
        function mostrarAlertaSeguranca() {
            // Atualizar texto do alerta para o idioma atual
            const lang = getCurrentLanguage();
            const alertTitle = document.querySelector('#security-alert h4');
            const alertParagraphs = document.querySelectorAll('#security-alert p');
            const alertButton = document.querySelector('#security-alert button');
            
            // Atualizar título
            alertTitle.textContent = alertTitle.getAttribute(`data-${lang.toLowerCase()}`);
            
            // Atualizar parágrafos
            alertParagraphs.forEach(p => {
                p.innerHTML = p.getAttribute(`data-${lang.toLowerCase()}`);
            });
            
            // Atualizar botão
            alertButton.textContent = alertButton.getAttribute(`data-${lang.toLowerCase()}`);
            
            // Mostrar alerta
            document.getElementById('security-alert').style.display = 'block';
            
            // Auto-esconder após 15 segundos
            setTimeout(function() {
                document.getElementById('security-alert').style.display = 'none';
            }, 15000);
        }
        
        // Novo: Verificar atualizações de bibliotecas
        function verificarAtualizacoesBibliotecas() {
            console.log('Verificando atualizações de bibliotecas...');
            
            // Verificar versão do LaserEyes
            if (typeof LaserEyes !== 'undefined' && typeof LaserEyes.version === 'string') {
                const versaoAtual = LaserEyes.version;
                
                // Aqui você poderia implementar uma chamada para um endpoint que retorna a versão mais recente
                // Por enquanto, apenas logamos a versão atual
                console.log('Versão atual do LaserEyes:', versaoAtual);
            }
            
            // Verificar versão do SatsConnect
            if (typeof window.SatsConnect !== 'undefined' && typeof window.SatsConnect.version === 'string') {
                const versaoAtual = window.SatsConnect.version;
                console.log('Versão atual do SatsConnect:', versaoAtual);
            }
            
            // Programar próxima verificação (a cada 24 horas)
            setTimeout(verificarAtualizacoesBibliotecas, 24 * 60 * 60 * 1000);
        }
        
        // Inicializar listeners quando a página carregar
        window.addEventListener('load', function() {
            console.log('Página carregada, inicializando listeners...');
            
            // Tentar inicializar LaserEyes de forma segura
            carregarLaserEyes().catch(error => {
                console.warn('Não foi possível carregar LaserEyes:', error);
                console.log('Continuando sem LaserEyes...');
            });
            
            // Adicionar event listeners para os botões
            document.getElementById('connect-btn').addEventListener('click', function(e) {
                e.preventDefault();
                console.log('Botão de conexão clicado');
                toggleWalletMenu();
            });
            
            document.getElementById('unisat-btn').addEventListener('click', function(e) {
                e.preventDefault();
                console.log('Botão Unisat clicado');
                WalletManager.connectUnisat().then(success => {
                    if (success) {
                        console.log('Conexão bem-sucedida');
                        atualizarUI('Carteira Conectada');
                    } else {
                        console.log('Falha na conexão');
                    }
                }).catch(error => {
                    console.error('Erro na conexão:', error);
                    mostrarErro(error.message);
                });
            });
            
            document.getElementById('disconnect-btn').addEventListener('click', function(e) {
                e.preventDefault();
                console.log('Botão de desconexão clicado');
                desconectarCarteira();
            });
            
            document.getElementById('close-overlay-btn').addEventListener('click', function() {
                document.getElementById('access-overlay').style.display = 'none';
            });
            document.getElementById('verify-btn').addEventListener('click', function() {
                if (WalletManager.isConnected()) {
                    WalletManager.verifyOrdinals(WalletManager.getAddress());
                } else {
                    mostrarErro('Conecte sua carteira primeiro');
                }
            });
            
            // Novos listeners para os alertas de segurança e inatividade
            document.getElementById('close-security-alert').addEventListener('click', function() {
                document.getElementById('security-alert').style.display = 'none';
            });
            
            document.getElementById('stay-connected-btn').addEventListener('click', continuarConectado);
            document.getElementById('disconnect-now-btn').addEventListener('click', function() {
                document.getElementById('inactivity-warning').style.display = 'none';
                WalletManager.disconnect();
            });
            
            // Verificar disponibilidade das extensões imediatamente
            verificarExtensoes();
            
            // Verificar atualizações de bibliotecas
            verificarAtualizacoesBibliotecas();
            
            // Mostrar alerta de segurança inicial
            setTimeout(mostrarAlertaSeguranca, 2000);
        });
        
        /**
         * Função para iniciar a experiência completa após verificação do Multiverso Pass
         * Esta função é chamada quando o acesso é concedido
         */
        function startExperience() {
            console.log('Iniciando experiência completa para detentor de Multiverso Pass');
            
            // Definir variáveis globais para acesso ao terreno exclusivo
            window.hasMultiversoPass = true;
            window.hasAccess = true;
            
            // Verificar se a função init existe (função principal do main.js)
            if (typeof init === 'function') {
                // Reinicializar a cena para aplicar as permissões
                console.log('Reinicializando cena com acesso completo');
                init();
            } else {
                console.warn('Função init não encontrada. Tentando atualizar acesso diretamente.');
                
                // Tentar atualizar o acesso diretamente se a função updateExclusiveAccess existir
                if (typeof updateExclusiveAccess === 'function') {
                    updateExclusiveAccess(true);
                }
                
                // Tentar tornar o terreno exclusivo visível diretamente
                if (typeof exclusiveLunarTerrain !== 'undefined' && exclusiveLunarTerrain) {
                    console.log('Tornando terreno exclusivo visível');
                    exclusiveLunarTerrain.visible = true;
                }
            }
            
            // Mostrar mensagem de sucesso
            mostrarSucesso('Acesso completo concedido! Você pode explorar todo o Multiverso agora.');
        }
    </script>
    
    <!-- Script para substituir usos inseguros de innerHTML -->
    <script>
        // Substituir innerHTML por métodos mais seguros
        document.addEventListener('DOMContentLoaded', function() {
            // Substituir todos os usos de innerHTML por métodos mais seguros
            const securelySetContent = (elementId, content, isHTML = false) => {
                const element = document.getElementById(elementId);
                if (!element) return;
                
                if (isHTML) {
                    // Quando precisamos realmente usar HTML, usamos uma abordagem mais segura
                    // Criamos um elemento temporário e definimos seu conteúdo
                    const temp = document.createElement('div');
                    temp.innerHTML = content;
                    
                    // Limpar o elemento de destino
                    while (element.firstChild) {
                        element.removeChild(element.firstChild);
                    }
                    
                    // Transferir nós filhos do temporário para o destino
                    while (temp.firstChild) {
                        element.appendChild(temp.firstChild);
                    }
                } else {
                    // Para conteúdo simples, usar textContent é mais seguro
                    element.textContent = content;
                }
            };
            
            // Substituir funções que usam innerHTML
            if (typeof window.originalSetInnerHTML === 'undefined') {
                // Guardar referências originais para compatibilidade
                window.originalSetInnerHTML = {};
                
                // Substituir funções específicas que usam innerHTML
                if (typeof window.mostrarSucesso === 'function') {
                    window.originalSetInnerHTML.mostrarSucesso = window.mostrarSucesso;
                    window.mostrarSucesso = function(mensagem, cor) {
                        const element = document.getElementById('success-message');
                        if (element) {
                            element.textContent = mensagem;
                            element.style.color = cor || 'green';
                            element.style.display = 'block';
                            
                            setTimeout(() => {
                                element.style.display = 'none';
                            }, 5000);
                        }
                    };
                }
                
                if (typeof window.mostrarErro === 'function') {
                    window.originalSetInnerHTML.mostrarErro = window.mostrarErro;
                    window.mostrarErro = function(mensagem) {
                        const element = document.getElementById('error-message');
                        if (element) {
                            element.textContent = mensagem;
                            element.style.display = 'block';
                            
                            setTimeout(() => {
                                element.style.display = 'none';
                            }, 5000);
                        }
                    };
                }
            }
            
            // Substituir os manipuladores de eventos que usam innerHTML
            const accessMessageElement = document.getElementById('access-message');
            if (accessMessageElement) {
                // Criar elementos para substituir o uso de innerHTML
                const createAccessMessage = (message) => {
                    // Limpar conteúdo atual
                    while (accessMessageElement.firstChild) {
                        accessMessageElement.removeChild(accessMessageElement.firstChild);
                    }
                    
                    // Criar e adicionar novo conteúdo
                    const paragraph = document.createElement('p');
                    paragraph.textContent = message;
                    accessMessageElement.appendChild(paragraph);
                };
                
                // Substituir as chamadas para innerHTML no código
                if (window.WalletManager && window.WalletManager.verifyOrdinals) {
                    const originalVerifyOrdinals = window.WalletManager.verifyOrdinals;
                    window.WalletManager.verifyOrdinals = function(address) {
                        // Substituir as chamadas para innerHTML
                        createAccessMessage('Verificando Ordinals...');
                        return originalVerifyOrdinals.call(this, address);
                    };
                }
            }
        });
    </script>
</body>
</html> 